<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Excel Report</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<style>
body{font-family:Arial;background:#f2f4f7;margin:10px}
.container{max-width:1200px;margin:auto;background:#fff;padding:15px;border-radius:8px}
table{width:100%;border-collapse:collapse;margin-top:10px}
th,td{border:1px solid #ccc;padding:6px}
th{background:#f0f0f0}
button,select,input{padding:6px 10px;border-radius:6px;border:1px solid #ccc}
button{background:#1976d2;color:#fff;cursor:pointer;border:none}
.topbar{display:flex;gap:8px;flex-wrap:wrap;margin-bottom:10px}
#printRange{display:none;margin-bottom:10px}
@media print{button,select,input,#printRange{display:none}}
</style>
</head>
<body>

<div class="container">
<h2>Excel View Report</h2>

<div class="topbar">
<button onclick="showPrintRange()">Print</button>
<button onclick="today()">Today</button>
<button onclick="month()">This Month</button>

<select id="org">
<option value="">All Organisation</option>
</select>

<button onclick="refreshData()">ðŸ”„ Refresh</button>
<button onclick="saveExcel()">ðŸ’¾ Save to Excel</button>
</div>

<div id="printRange">
 From <input type="date" id="from">
 To <input type="date" id="to">
 <button onclick="printRangeData()">Print</button>
</div>

<table id="tbl"></table>
</div>

<!-- SheetJS Library for Excel export -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

<script>
let fullData=[];
let data=[];

const tbl=document.getElementById("tbl");
const org=document.getElementById("org");
const from=document.getElementById("from");
const to=document.getElementById("to");
const printRange=document.getElementById("printRange");

// ---------- Load / Refresh ----------
function refreshData(){
 fullData = JSON.parse(localStorage.getItem("excelData") || "[]");
 data=[...fullData];
 populateOrg();
 render();
}

function populateOrg(){
 org.innerHTML="<option value=''>All Organisation</option>";
 [...new Set(fullData.map(d=>d.org))].forEach(o=>{
  let op=document.createElement("option");
  op.value=o; op.text=o;
  org.appendChild(op);
 });
}

org.onchange=()=>{
 data = org.value ? fullData.filter(d=>d.org===org.value) : [...fullData];
 render();
};

// ---------- Render ----------
function render(){
 let h="<tr><th>Date</th><th>Organisation</th><th>Name</th><th>Amount</th></tr>";
 let total=0;

 data
 .slice()
 .sort((a,b)=>b.date.localeCompare(a.date))
 .forEach(d=>{
  total+=+d.amt;
  h+=`<tr>
   <td>${d.date}</td>
   <td>${d.org}</td>
   <td>${d.name}</td>
   <td>${d.amt}</td>
  </tr>`;
 });

 h+=`<tr><th colspan="3">Total</th><th>${total}</th></tr>`;
 tbl.innerHTML=h;
}

// ---------- Date Shortcuts ----------
function today(){
 const t=new Date().toISOString().slice(0,10);
 data=fullData.filter(d=>d.date===t);
 render();
}

function month(){
 const m=new Date().toISOString().slice(0,7);
 data=fullData.filter(d=>d.date.startsWith(m));
 render();
}

// ---------- Print with Range ----------
function showPrintRange(){
 printRange.style.display = printRange.style.display==="none" ? "block" : "none";
}

function printRangeData(){
 if(!from.value || !to.value){
  alert("Please select From and To date");
  return;
 }
 data = fullData.filter(d=>d.date>=from.value && d.date<=to.value);
 render();
 window.print();
 data=[...fullData];
 render();
}

// ---------- Save to Excel ----------
function saveExcel(){
 if(fullData.length===0){ alert("No data to save"); return; }

 // Prepare worksheet
 const ws_data = [["Date","Organisation","Name","Amount"]];
 let total=0;
 fullData.forEach(d=>{
   ws_data.push([d.date,d.org,d.name,d.amt]);
   total+=+d.amt;
 });
 ws_data.push(["Total","","",total]);

 const ws = XLSX.utils.aoa_to_sheet(ws_data);
 const wb = XLSX.utils.book_new();
 XLSX.utils.book_append_sheet(wb, ws, "Report");

 XLSX.writeFile(wb, "Report.xlsx");
}

// ---------- Init ----------
refreshData();
</script>

</body>
</html>
