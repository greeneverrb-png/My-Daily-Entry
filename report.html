<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Full Report</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<style>
body{font-family:Arial;background:#f2f4f7;margin:10px}
.container{max-width:1100px;margin:auto;background:#fff;padding:15px;border-radius:8px}
table{width:100%;border-collapse:collapse;margin-top:10px}
th,td{border:1px solid #ccc;padding:6px;text-align:left;vertical-align:top}
button{padding:5px 8px;border:none;border-radius:5px;cursor:pointer;margin:2px}
.refreshBtn{float:right;font-size:18px;background:white;color:green;border-radius:50%;margin-left:5px}
.clickable{cursor:pointer;color:#1976d2;font-weight:bold}
.detailRow{background:#fafafa}
input{padding:4px;width:95%}
.clearfix::after{content:"";clear:both;display:table;}
.red{color:red;font-weight:bold}
</style>
</head>
<body>

<div class="container">
<h2>FULL REPORT
  <div class="clearfix">
    <button class="refreshBtn" onclick="refresh()">‚Üª</button>
    <button class="refreshBtn" onclick="printReport()">üñ®Ô∏è</button>
    <button class="refreshBtn" onclick="openExcel()">üìä</button>
  </div>
</h2>

<h3>Previous 7 Days</h3>
<table id="prev"></table>

<h3>Monthly</h3>
<table id="month"></table>

<h3 onclick="toggleAll()" class="clickable">All Records ‚¨á</h3>
<table id="all" style="display:none"></table>
</div>

<script>
const key="dailyEntries";
let data=JSON.parse(localStorage.getItem(key)||"[]").map(d=>({
  ...d,
  id:d.id||Date.now()+Math.random(),
  status:d.status||"",
  reason:d.reason||""
}));

let openDate=null;

// Save localStorage
function save(){localStorage.setItem(key,JSON.stringify(data));}

// Short display for status
function shortStatus(d){
 if(d.status==="Other" && d.reason) return d.reason.split(" ").slice(0,2).join(" ");
 return d.status||"";
}

// Change status
function changeStatus(id,val){
 let i=data.findIndex(d=>d.id===id);
 if(i<0) return;
 if(val==="Other"){
  let r=prompt("Enter reason for Other status");
  if(!r) return;
  data[i].status="Other";
  data[i].reason=r.trim();
 } else {
  data[i].status=val;
  data[i].reason="";
 }
 render();
}

// ---------- Render ----------
function render(){
 renderPrev();
 renderMonth();
 renderAll();
 save();
}

// Previous 7 Days
function renderPrev(){
 let g={};
 data.forEach(d=>{
  g[d.date]=g[d.date]||{nos:0,total:0};
  g[d.date].nos++;
  g[d.date].total+=+d.amt;
 });
 let h="<tr><th>Date</th><th>NOS</th><th>Total</th></tr>";
 Object.keys(g).sort().reverse().slice(0,7).forEach(d=>{
  h+=`<tr class="clickable" onclick="toggleDate('${d}')">
   <td>${d}</td><td>${g[d].nos}</td><td>${g[d].total.toFixed(2)}</td>
  </tr>
  <tr id="detail-${d}" class="detailRow" style="display:none">
   <td colspan="3"></td>
  </tr>`;
 });
 prev.innerHTML=h;
}

// Toggle detail
function toggleDate(date){
 let row=document.getElementById("detail-"+date);
 if(openDate && openDate!==date) document.getElementById("detail-"+openDate).style.display="none";

 if(row.style.display==="none"){
  let rows=data.filter(d=>d.date===date);
  let h="<table style='width:100%'><tr><th>Org</th><th>Name</th><th>Amt</th><th>Status</th></tr>";
  rows.forEach(r=>{
   let st=r.status==="Other"?r.reason:r.status;
   let cls=r.status==="Other"?"red":"";
   h+=`<tr>
    <td>${r.org}</td>
    <td>${r.name}</td>
    <td>${r.amt}</td>
    <td class="${cls}">${st}</td>
   </tr>`;
  });
  h+="</table>";
  row.children[0].innerHTML=h;
  row.style.display="table-row";
  openDate=date;
 } else {
  row.style.display="none";
  openDate=null;
 }
}

// Monthly summary
function renderMonth(){
 let g={};
 data.forEach(d=>{
  let m=d.date.slice(0,7);
  g[m]=(g[m]||0)+(+d.amt);
 });
 let h="<tr><th>Month</th><th>Total</th></tr>";
 Object.keys(g).sort().forEach(m=>{
  h+=`<tr><td>${m}</td><td>${g[m].toFixed(2)}</td></tr>`;
 });
 month.innerHTML=h;
}

// All Records
function renderAll(){
 let h="<tr><th>Date</th><th>Org</th><th>Name</th><th>Amt</th><th>Action</th></tr>";
 data.sort((a,b)=>b.date.localeCompare(a.date)).forEach(d=>{
  h+=`<tr id="row-${d.id}">
   <td><input type="date" id="ed-${d.id}" value="${d.date}"></td>
   <td><input id="eo-${d.id}" value="${d.org}"></td>
   <td><input id="en-${d.id}" value="${d.name}"></td>
   <td><input type="number" id="ea-${d.id}" value="${d.amt}"></td>
   <td>
    ${d.status==="" ? `<button onclick="saveRow('${d.id}')">Save</button><button onclick="del('${d.id}')">Delete</button>` : ``}
    <select onchange="changeStatus('${d.id}',this.value)">
     <option value="">Status</option>
     <option value="Done">Done</option>
     <option value="Pending">Pending</option>
     <option value="Other">Other</option>
    </select>
    <div class="${d.status==='Other'?'red':''}" style="font-size:12px">${shortStatus(d)}</div>
   </td>
  </tr>`;
 });
 all.innerHTML=h;
}

// Row Save
function saveRow(id){
 let i=data.findIndex(d=>d.id===id);
 if(i<0) return;
 data[i].date=document.getElementById("ed-"+id).value;
 data[i].org=document.getElementById("eo-"+id).value;
 data[i].name=document.getElementById("en-"+id).value;
 data[i].amt=+document.getElementById("ea-"+id).value;
 save();
 render();
}

// Delete
function del(id){
 if(!confirm("Delete this record?")) return;
 data=data.filter(d=>d.id!==id);
 render();
}

// Utilities
function toggleAll(){all.style.display=all.style.display==="none"?"table":"none";}
function refresh(){data=JSON.parse(localStorage.getItem(key)||"[]"); render();}
function printReport(){let w=window.open(""); w.document.write(document.querySelector(".container").innerHTML); w.print(); w.close();}
function openExcel(){localStorage.setItem("excelData",JSON.stringify(data)); window.open("reportExcel.html","_blank");}

render();
</script>

</body>
</html>
