<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Full Report</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<style>
body{font-family:Arial;background:#f2f4f7;margin:10px}
.container{max-width:1100px;margin:auto;background:#fff;padding:15px;border-radius:8px}
table{width:100%;border-collapse:collapse;margin-top:10px}
th,td{border:1px solid #ccc;padding:6px;text-align:left}
button{padding:6px 10px;border:none;border-radius:6px;cursor:pointer;margin:3px}
.edit{background:#1976d2;color:#fff}
.del{background:#d32f2f;color:#fff}
.topbar{display:flex;align-items:center;gap:10px;margin-bottom:10px;}
.topbar button{background:#444;color:#fff;font-size:14px;}
.refreshBtn{margin-left:auto;background:white;color:green;font-size:16px;font-weight:bold;border-radius:50%;padding:8px 12px;}
@media print{button,input{display:none}}
</style>
</head>
<body>
<div class="container">
<h2>FULL REPORT</h2>

<div class="topbar">
<button onclick="location.href='index.html'">← Back</button>
<button class="refreshBtn" id="refreshBtn">↻</button>
<button onclick="exportCSV()">Export Excel</button>
<button onclick="showPrintRange()">Print</button>
</div>

<div id="printRange" style="display:none;margin:10px 0">
From <input type="date" id="from">  
To <input type="date" id="to">
<button onclick="doPrint()">Print</button>
</div>

<h3>Previous Day Summary</h3>
<table id="prevTable"></table>

<h3>Monthly Summary</h3>
<table id="monthTable"></table>

<h3>All Records (Edit / Delete)</h3>
<table id="allTable"></table>

</div>

<script>
const key="dailyEntries";
let data = JSON.parse(localStorage.getItem(key) || "[]");

// --- Render functions ---
function render() {
 renderPrev();
 renderMonth();
 renderAll();
}

// --- Previous Day Summary ---
function renderPrev() {
 const grp = {};
 data.forEach(d=>{
  if(!grp[d.date]) grp[d.date] = {nos:0, total:0};
  grp[d.date].nos++; grp[d.date].total += d.amt;
 });
 let h = "<tr><th>Date</th><th>NOS</th><th>Total</th></tr>";
 Object.keys(grp).sort().reverse().forEach(d=>{
  h+=`<tr><td>${d}</td><td>${grp[d].nos}</td><td>${grp[d].total}</td></tr>`;
 });
 prevTable.innerHTML = h;
}

// --- Monthly Summary ---
function renderMonth() {
 const grp = {};
 data.forEach(d=>{
  const m = d.date.slice(0,7);
  if(!grp[m]) grp[m]=0;
  grp[m] += d.amt;
 });
 let h = "<tr><th>Month</th><th>Total</th></tr>";
 Object.keys(grp).sort().forEach(m=>{
  h+=`<tr><td>${m}</td><td>${grp[m]}</td></tr>`;
 });
 monthTable.innerHTML = h;
}

// --- All Records with row-specific Edit ---
function renderAll() {
 let h="<tr><th>Date</th><th>Org</th><th>Name</th><th>Amount</th><th>Action</th></tr>";
 const table = document.createElement('tbody');
 data.forEach(d=>{
  h+=`<tr>
   <td>${d.date}</td>
   <td>${d.org}</td>
   <td>${d.name}</td>
   <td>${d.amt}</td>
   <td>
    <button class="edit">Edit</button>
    <button class="del">Del</button>
   </td>
  </tr>`;
 });
 allTable.innerHTML = h;

 // Attach row-specific event listeners
 const rows = allTable.querySelectorAll('tr');
 rows.forEach((row, i)=>{
   if(i===0) return; // skip header
   const editBtn = row.querySelector('.edit');
   const delBtn = row.querySelector('.del');
   const entry = data[i-1];
   editBtn.addEventListener('click', ()=>{
     edit(entry);
   });
   delBtn.addEventListener('click', ()=>{
     del(entry);
   });
 });
}

// --- Edit row function ---
function edit(entry){
 if(!entry) return alert("Entry not found");
 const nd = prompt("Date", entry.date);
 const no = prompt("Organisation", entry.org);
 const nn = prompt("Name", entry.name);
 const na = prompt("Amount", entry.amt);
 if(nd && no && nn && na){
   entry.date = nd;
   entry.org = no;
   entry.name = nn;
   entry.amt = +na;
   save();
 }
}

// --- Delete row function ---
function del(entry){
 if(confirm("Delete?")){
   data = data.filter(x => x.id !== entry.id);
   save();
 }
}

// --- Save and rerender ---
function save(){
 localStorage.setItem(key, JSON.stringify(data));
 render();
}

// --- Refresh table button ---
document.getElementById('refreshBtn').addEventListener('click', ()=>{
 data = JSON.parse(localStorage.getItem(key) || "[]");
 render();
});

// --- Export CSV ---
function exportCSV(){
 let csv="Date,Organisation,Name,Amount\n";
 data.forEach(d => csv += `${d.date},${d.org},${d.name},${d.amt}\n`);
 const a = document.createElement("a");
 a.href = URL.createObjectURL(new Blob([csv]));
 a.download = "report.csv";
 a.click();
}

// --- Print ---
function showPrintRange(){
 document.getElementById("printRange").style.display="block";
}
function doPrint(){
 const f=from.value, t=to.value;
 if(!f||!t) return alert("Select date range");
 const old = data;
 data = data.filter(d => d.date >= f && d.date <= t);
 render();
 window.print();
 data = old;
 render();
}

// --- Initial render ---
render();
</script>
</body>
</html>
