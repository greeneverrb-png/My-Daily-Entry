<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Full Report</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<style>
body{font-family:Arial;background:#f2f4f7;margin:10px}
.container{max-width:1100px;margin:auto;background:#fff;padding:15px;border-radius:8px}
table{width:100%;border-collapse:collapse;margin-top:10px}
th,td{border:1px solid #ccc;padding:6px;text-align:left}
button{padding:6px 10px;border:none;border-radius:6px;cursor:pointer;margin:3px}
.edit{background:#1976d2;color:#fff}
.del{background:#d32f2f;color:#fff}
.topbar{display:flex;align-items:center;gap:10px;margin-bottom:10px;}
.topbar button{background:#444;color:#fff;font-size:14px;}
.refreshBtn{margin-left:auto;background:white;color:green;font-size:18px;font-weight:bold;border-radius:50%;padding:8px 12px;}
.clickable{cursor:pointer;color:#1976d2}
@media print{button,input{display:none}}
</style>
</head>
<body>

<div class="container">
<h2>FULL REPORT</h2>

<div class="topbar">
<button onclick="location.href='index.html'">← Back</button>
<button class="refreshBtn" id="refreshBtn">↻</button>
<button onclick="exportExcelPage()">Export Excel</button>
<button onclick="showPrintRange()">Print</button>
</div>

<div id="printRange" style="display:none;margin:10px 0">
From <input type="date" id="from">  
To <input type="date" id="to">
<button onclick="doPrint()">Print</button>
</div>

<h3>Previous Day Summary</h3>
<table id="prevTable"></table>

<h3>Monthly Summary</h3>
<table id="monthTable"></table>

<h3 class="clickable" onclick="toggleAll()">All Records (Edit / Delete) ⬇</h3>
<table id="allTable" style="display:none"></table>
</div>

<script>
const key="dailyEntries";

const prevTable=document.getElementById("prevTable");
const monthTable=document.getElementById("monthTable");
const allTable=document.getElementById("allTable");
const refreshBtn=document.getElementById("refreshBtn");
const printRange=document.getElementById("printRange");
const from=document.getElementById("from");
const to=document.getElementById("to");

let data = JSON.parse(localStorage.getItem(key) || "[]");
let showAll=false;

// ---------- Render ----------
function render(){
 renderPrev();
 renderMonth();
 if(showAll) renderAll();
}

// ---------- Previous Day ----------
function renderPrev(){
 const grp={};
 data.forEach(d=>{
  if(!grp[d.date]) grp[d.date]={nos:0,total:0};
  grp[d.date].nos++;
  grp[d.date].total+=d.amt;
 });
 let h="<tr><th>Date</th><th>NOS</th><th>Total</th></tr>";
 Object.keys(grp).sort().reverse().forEach(d=>{
  h+=`<tr><td>${d}</td><td>${grp[d].nos}</td><td>${grp[d].total}</td></tr>`;
 });
 prevTable.innerHTML=h;
}

// ---------- Monthly ----------
function renderMonth(){
 const grp={};
 data.forEach(d=>{
  const m=d.date.slice(0,7);
  grp[m]=(grp[m]||0)+d.amt;
 });
 let h="<tr><th>Month</th><th>Total</th></tr>";
 Object.keys(grp).sort().forEach(m=>{
  h+=`<tr><td>${m}</td><td>${grp[m]}</td></tr>`;
 });
 monthTable.innerHTML=h;
}

// ---------- Toggle ----------
function toggleAll(){
 showAll=!showAll;
 allTable.style.display=showAll?"table":"none";
 if(showAll) renderAll();
}

// ---------- All Records ----------
function renderAll(){
 let h="<tr><th>Date</th><th>Org</th><th>Name</th><th>Amount</th><th>Action</th></tr>";
 // Sort descending by date (latest first)
 data.slice().sort((a,b)=>b.date.localeCompare(a.date)).forEach(e=>{
  h+=`<tr>
   <td>${e.date}</td>
   <td>${e.org}</td>
   <td>${e.name}</td>
   <td>${e.amt}</td>
   <td>
    <button class="edit" onclick="edit(${e.id})">Edit</button>
    <button class="del" onclick="del(${e.id})">Del</button>
   </td>
  </tr>`;
 });
 allTable.innerHTML=h;
}

// ---------- Edit ----------
function edit(id){
 const e=data.find(x=>x.id===id);
 const d=prompt("Date",e.date);
 const o=prompt("Organisation",e.org);
 const n=prompt("Name",e.name);
 const a=prompt("Amount",e.amt);
 if(d&&o&&n&&a){
  e.date=d; e.org=o; e.name=n; e.amt=+a;
  save();
 }
}

// ---------- Delete ----------
function del(id){
 if(confirm("Delete this entry?")){
  data=data.filter(x=>x.id!==id);
  save();
 }
}

function save(){
 localStorage.setItem(key,JSON.stringify(data));
 render();
}

// ---------- Refresh ----------
refreshBtn.onclick=()=>{
 data=JSON.parse(localStorage.getItem(key)||"[]");
 render();
}

// ---------- Export Excel Page ----------
function exportExcelPage(){
 localStorage.setItem("excelData", JSON.stringify(data));
 window.open("reportExcel.html","_blank");
}

// ---------- Print ----------
function showPrintRange(){
 printRange.style.display="block";
}
function doPrint(){
 if(!from.value||!to.value) return alert("Select date range");
 const old=[...data];
 showAll=false;
 allTable.style.display="none";
 data=data.filter(d=>d.date>=from.value && d.date<=to.value);
 render();
 window.print();
 data=old;
 render();
}

render();
</script>
</body>
</html>
