<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Full Report</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<style>
body{font-family:Arial;background:#f2f4f7;margin:10px}
.container{max-width:1100px;margin:auto;background:#fff;padding:15px;border-radius:8px}
table{width:100%;border-collapse:collapse;margin-top:10px}
th,td{border:1px solid #ccc;padding:6px;text-align:left}
button{padding:5px 8px;border:none;border-radius:5px;cursor:pointer;margin:2px}
.refreshBtn{float:right;font-size:18px;background:white;color:green;border-radius:50%;margin-left:5px}
.clickable{cursor:pointer;color:#1976d2;font-weight:bold}
.detailRow{background:#fafafa}
input{padding:4px;width:95%}
.clearfix::after{content:"";clear:both;display:table;}
</style>
</head>
<body>

<div class="container">
<h2>FULL REPORT
  <div class="clearfix">
    <button class="refreshBtn" onclick="refresh()">‚Üª</button>
    <button class="refreshBtn" onclick="printReport()">üñ®Ô∏è</button>
    <button class="refreshBtn" onclick="exportExcel()">üì•</button>
  </div>
</h2>

<h3>Previous 7 Days</h3>
<table id="prev"></table>

<h3>Monthly</h3>
<table id="month"></table>

<h3 onclick="toggleAll()" class="clickable">All Records ‚¨á</h3>
<table id="all" style="display:none"></table>
</div>

<script>
const key="dailyEntries";
let data = JSON.parse(localStorage.getItem(key)||"[]");

// Ensure every record has unique ID
data = data.map(d=>d.id?d:{...d,id:Date.now()+Math.random()});

let openDate=null;
let editingId=null;

function save(){ localStorage.setItem(key,JSON.stringify(data)); }

// ---------- Render All ----------
function render(){
 renderPrev();
 renderMonth();
 renderAll();
 save();
}

// ---------- Previous 7 Days ----------
function renderPrev(){
 let grp={};
 data.forEach(d=>{
  grp[d.date]=grp[d.date]||{nos:0,total:0};
  grp[d.date].nos++;
  grp[d.date].total+=parseFloat(d.amt||0);
 });

 let html="<tr><th>Date</th><th>NOS</th><th>Total</th></tr>";
 Object.keys(grp).sort().reverse().slice(0,7).forEach(d=>{
  html+=`<tr class="clickable" onclick="toggleDate('${d}')">
     <td>${d}</td><td>${grp[d].nos}</td><td>${grp[d].total.toFixed(2)}</td>
   </tr>
   <tr id="detail-${d}" class="detailRow" style="display:none">
     <td colspan="3"></td>
   </tr>`;
 });
 document.getElementById("prev").innerHTML=html;
}

function toggleDate(date){
 let row=document.getElementById("detail-"+date);

 if(openDate && openDate!==date){
  document.getElementById("detail-"+openDate).style.display="none";
 }

 if(row.style.display==="none"){
  let rows=data.filter(d=>d.date===date);
  let html="<table style='width:100%'><tr><th>Org</th><th>Name</th><th>Amt</th></tr>";
  rows.forEach(r=>{
   html+=`<tr><td>${r.org}</td><td>${r.name}</td><td>${r.amt}</td></tr>`;
  });
  html+="</table>";
  row.children[0].innerHTML=html;
  row.style.display="table-row";
  openDate=date;
 }else{
  row.style.display="none";
  openDate=null;
 }
}

// ---------- Monthly ----------
function renderMonth(){
 let grp={};
 data.forEach(d=>{
  let m=d.date.slice(0,7);
  grp[m]=(grp[m]||0)+parseFloat(d.amt||0);
 });

 let html="<tr><th>Month</th><th>Total</th></tr>";
 Object.keys(grp).sort().forEach(m=>{
  html+=`<tr><td>${m}</td><td>${grp[m].toFixed(2)}</td></tr>`;
 });
 document.getElementById("month").innerHTML=html;
}

// ---------- All Records ----------
function renderAll(){
 let html="<tr><th>Date</th><th>Org</th><th>Name</th><th>Amt</th><th>Action</th></tr>";

 data.sort((a,b)=>b.date.localeCompare(a.date)).forEach(d=>{
  if(editingId===d.id){
   html+=`<tr>
     <td><input id="e-date-${d.id}" type="date" value="${d.date}"></td>
     <td><input id="e-org-${d.id}" value="${d.org}"></td>
     <td><input id="e-name-${d.id}" value="${d.name}"></td>
     <td><input id="e-amt-${d.id}" type="number" value="${d.amt}"></td>
     <td>
       <button onclick="saveEdit('${d.id}')">Save</button>
       <button onclick="editingId=null;render()">Cancel</button>
     </td>
   </tr>`;
  }else{
   html+=`<tr>
     <td>${d.date}</td><td>${d.org}</td><td>${d.name}</td><td>${d.amt}</td>
     <td>
       <button onclick="editingId='${d.id}';render()">Edit</button>
       <button onclick="del('${d.id}')">Delete</button>
     </td>
   </tr>`;
  }
 });

 document.getElementById("all").innerHTML=html;
}

function saveEdit(id){
 let i=data.findIndex(d=>d.id===id);
 data[i].date=document.getElementById(`e-date-${id}`).value;
 data[i].org=document.getElementById(`e-org-${id}`).value;
 data[i].name=document.getElementById(`e-name-${id}`).value;
 data[i].amt=parseFloat(document.getElementById(`e-amt-${id}`).value||0);
 editingId=null;
 render();
}

function del(id){
 if(!confirm("Delete this record?")) return;
 data=data.filter(d=>d.id!==id);
 render();
}

function toggleAll(){
 let t=document.getElementById("all");
 t.style.display=t.style.display==="none"?"table":"none";
}

function refresh(){
 data=JSON.parse(localStorage.getItem(key)||"[]");
 render();
}

// ---------- Print ----------
function printReport(){
  let content = document.querySelector('.container').innerHTML;
  let w = window.open('', '', 'width=900,height=700');
  w.document.write(`<html><head><title>Print Report</title>
    <style>
      body{font-family:Arial;margin:10px}
      table{width:100%;border-collapse:collapse;margin-top:10px}
      th,td{border:1px solid #ccc;padding:6px;text-align:left}
    </style>
    </head><body>${content}</body></html>`);
  w.document.close();
  w.focus();
  w.print();
  w.close();
}

// ---------- Excel Export ----------
function exportExcel(){
  let table = document.getElementById('all'); // export All Records table
  let html = table.outerHTML;
  let blob = new Blob([html], {type: "application/vnd.ms-excel"});
  let url = URL.createObjectURL(blob);
  let a = document.createElement('a');
  a.href = url;
  a.download = `Full_Report_${new Date().toISOString().slice(0,10)}.xls`;
  a.click();
  URL.revokeObjectURL(url);
}

render();
</script>

</body>
</html>
