<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Full Report</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<style>
body{font-family:Arial;background:#f2f4f7;margin:10px}
.container{max-width:1100px;margin:auto;background:#fff;padding:15px;border-radius:8px}
table{width:100%;border-collapse:collapse;margin-top:10px}
th,td{border:1px solid #ccc;padding:6px;text-align:left}
button{padding:6px 10px;border:none;border-radius:6px;cursor:pointer;margin:2px}
.topbar{display:flex;align-items:center;gap:10px;margin-bottom:10px}
.topbar button{background:#444;color:#fff}
.refreshBtn{margin-left:auto;background:white;color:green;font-size:18px;font-weight:bold;border-radius:50%}
.clickable{cursor:pointer;color:#1976d2;font-weight:bold}
.detailRow td{background:#fafafa}
input.inline-edit{width:95%;padding:2px}
@media print{button,input{display:none}}
</style>
</head>
<body>

<div class="container">
<h2>FULL REPORT</h2>

<div class="topbar">
<button onclick="location.href='index.html'">← Back</button>
<button class="refreshBtn" id="refreshBtn">↻</button>
<button onclick="exportExcelPage()">Export Excel</button>
</div>

<h3>Previous 7 Days Summary</h3>
<table id="prevTable"></table>

<h3>Monthly Summary</h3>
<table id="monthTable"></table>

<h3 class="clickable" onclick="toggleAll()">All Records (Edit / Delete) ⬇</h3>
<input id="searchBox" placeholder="Search by Date / Org / Name / Amount" style="width:100%;padding:8px;margin-bottom:8px;display:none">
<table id="allTable" style="display:none"></table>
</div>

<script>
const key="dailyEntries";
let data = JSON.parse(localStorage.getItem(key)||"[]");

const prevTable=document.getElementById("prevTable");
const monthTable=document.getElementById("monthTable");
const allTable=document.getElementById("allTable");
const refreshBtn=document.getElementById("refreshBtn");

let openDate=null, showAll=false;
let editingIndex = null; // track which row is editing

// ---------- Render ----------
function render(){
  renderPrev7();
  renderMonth();
  if(showAll) renderAll();
}

// ---------- Previous 7 Days ----------
function renderPrev7(){
  const grp={};
  data.forEach(d=>{
    if(!d.date) return;
    if(!grp[d.date]) grp[d.date]={nos:0,total:0};
    grp[d.date].nos++;
    grp[d.date].total += parseFloat(d.amt||0);
  });
  const dates = Object.keys(grp).sort().reverse().slice(0,7);
  let h="<tr><th>Date</th><th>NOS</th><th>Total</th></tr>";
  dates.forEach(d=>{
    h+=`<tr class="clickable" onclick="toggleDate('${d}')">
          <td>${d}</td>
          <td>${grp[d].nos}</td>
          <td>${grp[d].total}</td>
        </tr>
        <tr id="detail-${d}" class="detailRow" style="display:none">
          <td colspan="3"></td>
        </tr>`;
  });
  prevTable.innerHTML=h;
}

// ---------- Toggle Date Detail ----------
function toggleDate(date){
  const row=document.getElementById("detail-"+date);
  if(openDate && openDate!==date) document.getElementById("detail-"+openDate).style.display="none";
  if(row.style.display==="none"){
    const rows=data.filter(d=>d.date===date);
    let h="<table style='width:100%'><tr><th>Org</th><th>Name</th><th>Amount</th></tr>";
    rows.forEach(r=>{
      h+=`<tr><td>${r.org}</td><td>${r.name}</td><td>${parseFloat(r.amt||0)}</td></tr>`;
    });
    h+="</table>";
    row.children[0].innerHTML=h;
    row.style.display="table-row";
    openDate=date;
  } else {
    row.style.display="none";
    openDate=null;
  }
}

// ---------- Monthly ----------
function renderMonth(){
  const grp={};
  data.forEach(d=>{
    if(!d.date) return;
    const m=d.date.slice(0,7);
    grp[m] = (grp[m]||0) + parseFloat(d.amt||0);
  });
  let h="<tr><th>Month</th><th>Total</th></tr>";
  Object.keys(grp).sort().forEach(m=>{
    h+=`<tr><td>${m}</td><td>${grp[m]}</td></tr>`;
  });
  monthTable.innerHTML=h;
}

// ---------- Toggle All ----------
function toggleAll(){
  showAll=!showAll;
  allTable.style.display=showAll?"table":"none";
  document.getElementById("searchBox").style.display=showAll?"block":"none";
  if(showAll) renderAll();
}

// ---------- All Records ----------
function renderAll(){
  const s=(document.getElementById("searchBox").value||"").toLowerCase();
  let h="<tr><th>Date</th><th>Org</th><th>Name</th><th>Amount</th><th>Action</th></tr>";
  data.slice().sort((a,b)=>b.date.localeCompare(a.date)).forEach((e,i)=>{
    if(!e.date) return;
    if(s && !(`${e.date} ${e.org} ${e.name} ${e.amt}`.toLowerCase().includes(s))) return;

    if(editingIndex===i){
      // Inline edit row
      h+=`<tr>
        <td><input class="inline-edit" type="date" id="edit-date" value="${e.date}"></td>
        <td><input class="inline-edit" type="text" id="edit-org" value="${e.org}"></td>
        <td><input class="inline-edit" type="text" id="edit-name" value="${e.name}"></td>
        <td><input class="inline-edit" type="number" id="edit-amt" value="${parseFloat(e.amt||0)}"></td>
        <td>
          <button onclick="saveEdit(${i})">Save</button>
          <button onclick="cancelEdit()">Cancel</button>
        </td>
      </tr>`;
    } else {
      h+=`<tr>
        <td>${e.date}</td>
        <td>${e.org}</td>
        <td>${e.name}</td>
        <td>${parseFloat(e.amt||0)}</td>
        <td>
          <button onclick="startEdit(${i})">Edit</button>
          <button onclick="deleteEntry(${i})">Delete</button>
        </td>
      </tr>`;
    }
  });
  allTable.innerHTML=h;
}

// ---------- Start Edit ----------
function startEdit(i){
  editingIndex = i;
  renderAll();
}

// ---------- Cancel Edit ----------
function cancelEdit(){
  editingIndex = null;
  renderAll();
}

// ---------- Save Edit ----------
function saveEdit(i){
  const date = document.getElementById("edit-date").value;
  const org = document.getElementById("edit-org").value;
  const name = document.getElementById("edit-name").value;
  const amt = parseFloat(document.getElementById("edit-amt").value||0);
  if(!date || !name || !org || isNaN(amt)) { alert("Invalid input"); return; }

  data[i] = {date, org, name, amt};
  localStorage.setItem(key,JSON.stringify(data));
  editingIndex = null;
  render();
}

// ---------- Delete ----------
function deleteEntry(i){
  if(!confirm("Delete this record?")) return;
  data.splice(i,1);
  localStorage.setItem(key,JSON.stringify(data));
  render();
}

// ---------- Refresh ----------
refreshBtn.onclick=()=>{
  data=JSON.parse(localStorage.getItem(key)||"[]");
  render();
};

// ---------- Export ----------
function exportExcelPage(){
  localStorage.setItem("excelData",JSON.stringify(data));
  window.open("reportExcel.html","_blank");
}

document.getElementById("searchBox").addEventListener("input",renderAll);
render();
</script>

</body>
</html>
